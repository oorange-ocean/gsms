FROM node:18-alpine

WORKDIR /app

# 设置shell环境变量
ENV SHELL=/bin/sh

# 全局安装 pnpm，但不使用全局安装NestJS CLI
RUN corepack enable && corepack prepare pnpm@latest --activate

# 首先复制包文件
COPY package*.json pnpm-lock.yaml* ./

# 安装依赖，包括NestJS CLI作为本地开发依赖
RUN pnpm install
RUN pnpm add -D @nestjs/cli

# 确保包可以全局可执行
RUN mkdir -p node_modules/.bin && \
    ln -sf ../node_modules/.bin/nest /usr/local/bin/nest || true

# 设置正确的权限
RUN mkdir -p node_modules && chown -R node:node /app

# 切换到非root用户
USER node

# 启动开发服务器
CMD ["pnpm", "run", "start:dev"]